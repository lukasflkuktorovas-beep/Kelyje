<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Expense Split App</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body { font-family: Arial, sans-serif; padding: 20px; max-width: 900px; margin: auto; }
h2 { margin-top: 30px; }
input, select, button { padding: 6px; margin: 4px 0; }
button { cursor: pointer; }
section { border: 1px solid #ccc; padding: 15px; margin-bottom: 20px; }
label { display: block; }
table { width: 100%; border-collapse: collapse; margin-top: 10px; }
th, td { border: 1px solid #ccc; padding: 6px; text-align: left; }
</style>
</head>

<body>

<h1>Expense Split App</h1>

<!-- PEOPLE -->
<section>
<h2>People</h2>
<input id="newPerson" placeholder="Add name">
<button onclick="addPerson()">Add</button>
<ul id="peopleList"></ul>
</section>

<!-- SETTINGS -->
<section>
<h2>Currency Settings</h2>
Base currency: <b>GBP (£)</b><br><br>
<label>USD → GBP
<input id="rateUSD" type="number" step="0.01"></label>
<label>EUR → GBP
<input id="rateEUR" type="number" step="0.01"></label>
<button onclick="saveRates()">Save Rates</button>
</section>

<!-- EXPENSES -->
<section>
<h2>Add Expense</h2>
<input id="desc" placeholder="Description"><br>
<input id="amount" type="number" step="0.01" placeholder="Amount"><br>

<select id="currency">
  <option value="GBP">GBP</option>
  <option value="USD">USD</option>
  <option value="EUR">EUR</option>
</select><br>

Paid by:
<select id="paidBy"></select>

<h4>Participants</h4>
<div id="participants"></div>

<button onclick="addExpense()">Add Expense</button>
</section>

<!-- PAYMENTS -->
<section>
<h2>Add Payment</h2>
<select id="payFrom"></select> paid
<select id="payTo"></select>
<input id="payAmount" type="number" step="0.01">
<button onclick="addPayment()">Add Payment</button>
</section>

<!-- BALANCES -->
<section>
<h2>Balances (GBP)</h2>
<ul id="balances"></ul>
</section>

<!-- SETTLEMENT -->
<section>
<h2>Settlement</h2>
<ul id="settlement"></ul>
</section>

<script>
let people = JSON.parse(localStorage.getItem("people")) || [];
let expenses = JSON.parse(localStorage.getItem("expenses")) || [];
let payments = JSON.parse(localStorage.getItem("payments")) || [];
let rates = JSON.parse(localStorage.getItem("rates")) || { USD: 0.8, EUR: 0.9 };

function saveAll() {
  localStorage.setItem("people", JSON.stringify(people));
  localStorage.setItem("expenses", JSON.stringify(expenses));
  localStorage.setItem("payments", JSON.stringify(payments));
  localStorage.setItem("rates", JSON.stringify(rates));
  renderAll();
}

function addPerson() {
  const n = newPerson.value.trim();
  if (!n || people.includes(n)) return;
  people.push(n);
  newPerson.value = "";
  saveAll();
}

function renderPeople() {
  peopleList.innerHTML = "";
  people.forEach(p => {
    const li = document.createElement("li");
    li.innerHTML = `${p} <button onclick="removePerson('${p}')">❌</button>`;
    peopleList.appendChild(li);
  });

  [paidBy, payFrom, payTo].forEach(sel => {
    sel.innerHTML = "";
    people.forEach(p => sel.add(new Option(p, p)));
  });

  participants.innerHTML = "";
  people.forEach(p => {
    participants.innerHTML += `<label><input type="checkbox" value="${p}" checked> ${p}</label>`;
  });
}

function removePerson(p) {
  people = people.filter(x => x !== p);
  saveAll();
}

function saveRates() {
  rates.USD = parseFloat(rateUSD.value);
  rates.EUR = parseFloat(rateEUR.value);
  saveAll();
}

function convertToGBP(amount, currency) {
  if (currency === "GBP") return amount;
  return amount * rates[currency];
}

function addExpense() {
  const selected = [...participants.querySelectorAll("input:checked")].map(x => x.value);
  if (!selected.length) return;

  expenses.push({
    desc: desc.value,
    amount: convertToGBP(+amount.value, currency.value),
    paidBy: paidBy.value,
    participants: selected
  });
  desc.value = amount.value = "";
  saveAll();
}

function addPayment() {
  payments.push({
    from: payFrom.value,
    to: payTo.value,
    amount: +payAmount.value
  });
  payAmount.value = "";
  saveAll();
}

function calculateBalances() {
  let bal = {};
  people.forEach(p => bal[p] = 0);

  expenses.forEach(e => {
    const share = e.amount / e.participants.length;
    e.participants.forEach(p => bal[p] -= share);
    bal[e.paidBy] += e.amount;
  });

  payments.forEach(p => {
    bal[p.from] += p.amount;
    bal[p.to] -= p.amount;
  });

  return bal;
}

function renderBalances() {
  balances.innerHTML = "";
  const b = calculateBalances();
  for (let p in b) {
    balances.innerHTML += `<li>${p}: £${b[p].toFixed(2)}</li>`;
  }
}

function renderSettlement() {
  settlement.innerHTML = "";
  const b = calculateBalances();
  let debtors = [], creditors = [];

  for (let p in b) {
    if (b[p] < 0) debtors.push([p, -b[p]]);
    if (b[p] > 0) creditors.push([p, b[p]]);
  }

  debtors.forEach(d => {
    creditors.forEach(c => {
      if (d[1] &&
